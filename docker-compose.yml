version: "3.9"

############################
# 公共配置（模板）
############################
x-jeepay-service: &jeepay-service
  restart: unless-stopped
  networks:
    - jeepay
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

############################
# 服务定义
############################
services:

  mysql:
    image: mysql:8
    container_name: jeepay-mysql
    environment:
      LANG: C.UTF-8
      MYSQL_ROOT_PASSWORD: rootroot
      MYSQL_DATABASE: jeepaydb
      MYSQL_USER: jeepay
      MYSQL_PASSWORD: jeepay
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docs/sql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - jeepay

  redis:
    image: redis:7
    container_name: jeepay-redis
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - jeepay

  ############################
  # RocketMQ
  ############################
  rocketmq-namesrv:
    image: apache/rocketmq:4.9.3
    platform: linux/amd64
    container_name: jeepay-rmq-namesrv
    command: sh mqnamesrv
    ports:
      - "9876:9876"
    volumes:
      - rocketmq-namesrv-logs:/home/rocketmq/logs
    networks:
      - jeepay

  rocketmq-broker:
    image: apache/rocketmq:4.9.3
    platform: linux/amd64
    container_name: jeepay-rmq-broker
    depends_on:
      - rocketmq-namesrv
    environment:
      NAMESRV_ADDR: rocketmq-namesrv:9876
    command: sh mqbroker -c /opt/rocketmq-4.9.3/conf/broker.conf
    ports:
      - "10911:10911"
      - "10909:10909"
    volumes:
#      - rocketmq-broker-store:/home/rocketmq/store  挂载store由于有mmap大文件本地启动容器失败
      - rocketmq-broker-logs:/home/rocketmq/logs
      - ./docker/rocketmq/broker/conf/broker.conf:/opt/rocketmq-4.9.3/conf/broker.conf
    networks:
      - jeepay

  ############################
  # 后端服务
  ############################
  payment:
    <<: *jeepay-service
    image: ${IMAGE_PREFIX}jeepay-payment:${IMAGE_TAG}
    build:
      context: ./jeepay-payment
      dockerfile: Dockerfile
      args:
        PORT: 9216
        PLATFORM: payment
    container_name: jeepay-payment
    ports:
      - "9216:9216"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rocketmq-broker:
        condition: service_started
    volumes:
      - ./logs/payment:/workspace/logs
      - ./conf/payment/application.yml:/workspace/application.yml

  manager:
    <<: *jeepay-service
    image: ${IMAGE_PREFIX}jeepay-manager:${IMAGE_TAG}
    build:
      context: ./jeepay-manager
      dockerfile: Dockerfile
      args:
        PORT: 9217
        PLATFORM: manager
    container_name: jeepay-manager
    ports:
      - "9217:9217"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rocketmq-broker:
        condition: service_started
    volumes:
      - ./logs/manager:/workspace/logs
      - ./conf/manager/application.yml:/workspace/application.yml

  merchant:
    <<: *jeepay-service
    image: ${IMAGE_PREFIX}jeepay-merchant:${IMAGE_TAG}
    build:
      context: ./jeepay-merchant
      dockerfile: Dockerfile
      args:
        PORT: 9218
        PLATFORM: merchant
    container_name: jeepay-merchant
    ports:
      - "9218:9218"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rocketmq-broker:
        condition: service_started
    volumes:
      - ./logs/merchant:/workspace/logs
      - ./conf/merchant/application.yml:/workspace/application.yml

  ############################
  # 前端 UI
  ############################
  ui-payment:
    <<: *jeepay-service
    image: ${IMAGE_PREFIX}jeepay-ui-payment:${IMAGE_TAG}
    build:
      context: ${UI_BASE_DIR}/jeepay-ui
      dockerfile: Dockerfile
      args:
        PLATFORM: cashier
    container_name: jeepay-ui-payment
    environment:
      BACKEND_HOST: payment:9216
    ports:
      - "9226:80"
    depends_on:
      - payment

  ui-manager:
    <<: *jeepay-service
    image: ${IMAGE_PREFIX}jeepay-ui-manager:${IMAGE_TAG}
    build:
      context: ${UI_BASE_DIR}/jeepay-ui
      dockerfile: Dockerfile
      args:
        PLATFORM: manager
    container_name: jeepay-ui-manager
    environment:
      BACKEND_HOST: manager:9217
    ports:
      - "9227:80"
    depends_on:
      - manager

  ui-merchant:
    <<: *jeepay-service
    image: ${IMAGE_PREFIX}jeepay-ui-merchant:${IMAGE_TAG}
    build:
      context: ${UI_BASE_DIR}/jeepay-ui
      dockerfile: Dockerfile
      args:
        PLATFORM: merchant
    container_name: jeepay-ui-merchant
    environment:
      BACKEND_HOST: merchant:9218
    ports:
      - "9228:80"
    depends_on:
      - merchant

############################
# 网络 & 数据卷
############################
networks:
  jeepay:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  rocketmq-namesrv-logs:
  rocketmq-broker-store:
  rocketmq-broker-logs:
